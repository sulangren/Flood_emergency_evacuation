(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function s(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerpolicy&&(i.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?i.credentials="include":e.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(e){if(e.ep)return;e.ep=!0;const i=s(e);fetch(e.href,i)}})();class p{constructor(t){this.viewer=t,this.waterEntities=[],this.isDynamicSimulating=!1,this.currentWaterLevel=0,this.waterMaterial=this.createWaterMaterial(),this.buildingTilesets=[],this.controlPoints=[],this.waterSurface=void 0,this.rainParticleSystem=null}createWaterMaterial(){return new Cesium.Material({fabric:{type:"Water",uniforms:{baseWaterColor:new Cesium.Color(.2,.5,.8,.6),normalMap:"/textures/waterNormals.jpg",frequency:200,animationSpeed:.08,amplitude:2}}})}async setWaterLevel(t){this.currentWaterLevel=t,this.waterSurface&&(this.viewer.entities.remove(this.waterSurface),this.waterSurface=void 0),this.waterSurface=this.viewer.entities.add({name:"\u6C34\u9762",rectangle:{coordinates:Cesium.Rectangle.fromDegrees(113.4,34.6,113.8,34.9),material:new Cesium.ImageMaterialProperty({image:"/textures/waterNormals.jpg",repeat:new Cesium.Cartesian2(10,10),color:new Cesium.Color(.2,.5,.8,1)}),height:80,extrudedHeight:80+t*.2,outline:!1}}),this.updateBuildingsFloodState()}updateBuildingsFloodState(){const t=[],s=this.viewer.scene.primitives;for(let n=0;n<s.length;n++){const e=s.get(n);e instanceof Cesium.Cesium3DTileset&&t.push(e)}t.forEach(n=>{n.style=new Cesium.Cesium3DTileStyle({color:{conditions:[[`\${Height} <= ${this.currentWaterLevel}`,"color(0.2, 0.5, 0.8, 0.5)"],["true","color(1.0, 1.0, 1.0, 1.0)"]]}})})}async startDynamicSimulation(t,s=100){if(this.isDynamicSimulating)return;this.isDynamicSimulating=!0;const n=[{position:t,level:0}],e=new Set;for(;this.isDynamicSimulating&&n.length>0;){const i=n.shift(),r=this.getCellKey(i.position);if(e.has(r))continue;e.add(r);const l=await this.getElevation(i.position),c=i.level*.2;if(c>=l){this.createWaterCell(i.position,c);for(let a=0;a<8;a++){const u=this.getNeighborPosition(i.position,a);n.push({position:u,level:i.level+1})}}await new Promise(a=>setTimeout(a,s))}this.isDynamicSimulating=!1}stopDynamicSimulation(){this.isDynamicSimulating=!1,this.clearWaterEffects()}getCellKey(t){const s=Cesium.Cartographic.fromCartesian(t),n=Math.floor(s.latitude*1e4),e=Math.floor(s.longitude*1e4);return`${n}_${e}`}createWaterCell(t,s){const n=this.viewer.entities.add({position:t,polygon:{hierarchy:new Cesium.CircleGeometry({center:t,radius:25}),material:new Cesium.Color(.2,.5,.8,.5),height:s,extrudedHeight:s+.5,outline:!0,outlineColor:Cesium.Color.BLACK}});return this.waterEntities.push(n),n}async getElevation(t){try{const s=Cesium.Cartographic.fromCartesian(t);return(await Cesium.sampleTerrainMostDetailed(this.viewer.terrainProvider,[s]))[0].height}catch(s){return console.error("\u83B7\u53D6\u9AD8\u7A0B\u5931\u8D25:",s),0}}getNeighborPosition(t,s){const n=[[1e-4,0],[1e-4,1e-4],[0,1e-4],[-1e-4,1e-4],[-1e-4,0],[-1e-4,-1e-4],[0,-1e-4],[1e-4,-1e-4]],e=Cesium.Cartographic.fromCartesian(t);return Cesium.Cartesian3.fromRadians(e.longitude+n[s][0],e.latitude+n[s][1],e.height)}clearWaterEffects(){this.waterEntities.forEach(t=>this.viewer.entities.remove(t)),this.waterEntities=[],this.viewer.scene.globe.heightOffset=0,this.viewer.scene.globe.material=void 0}addTestBuilding(t,s=20){return this.viewer.entities.add({name:"\u6D4B\u8BD5\u5EFA\u7B51",position:t,box:{dimensions:new Cesium.Cartesian3(30,30,s),material:Cesium.Color.GRAY.withAlpha(.8),outline:!0,outlineColor:Cesium.Color.BLACK}})}addDrainageOutlet(t){return this.viewer.entities.add({name:"\u6392\u6C34\u53E3",position:t,cylinder:{length:5,topRadius:0,bottomRadius:3,material:Cesium.Color.RED.withAlpha(.7)}})}startRain(t=50,s=20,n=0){var u;const e=this.viewer.scene.canvas;if(e.clientWidth===0||e.clientHeight===0){console.warn(`\u{1F6AB} [Rain] Canvas\u5C3A\u5BF8\u4E3A0\uFF0C\u7B49\u5F85\u6E32\u67D3... \u7B2C${n+1}\u6B21`),n<5&&setTimeout(()=>this.startRain(t,s,n+1),500);return}const i=(u=this.viewer.camera)==null?void 0:u.positionWC;if(!i){console.warn("\u{1F6AB} [Rain] \u76F8\u673A\u4F4D\u7F6E\u672A\u51C6\u5907\u597D\uFF0C\u7A0D\u540E\u91CD\u8BD5..."),n<5&&setTimeout(()=>this.startRain(t,s,n+1),500);return}this.rainParticleSystem&&(this.viewer.scene.primitives.remove(this.rainParticleSystem),this.rainParticleSystem=null);const r="/textures/rain.png",l=30,c=Cesium.Transforms.eastNorthUpToFixedFrame(i);this.rainParticleSystem=new Cesium.ParticleSystem({image:r,startColor:Cesium.Color.WHITE.withAlpha(.2),endColor:Cesium.Color.WHITE.withAlpha(0),startScale:s/100,endScale:s/100,minimumSpeed:20,maximumSpeed:30,lifetime:.8,emissionRate:t,emitter:new Cesium.BoxEmitter(new Cesium.Cartesian3(l,l,5)),modelMatrix:Cesium.Matrix4.IDENTITY,emitterModelMatrix:c,updateCallback:function(d,h){Cesium.Cartesian3.add(d.position,new Cesium.Cartesian3(0,0,-h*100),d.position)}}),this.viewer.scene.primitives.add(this.rainParticleSystem);const a=this;this.viewer.scene.postUpdate.addEventListener(()=>{if(!a.rainParticleSystem||!a.viewer||!a.viewer.camera)return;const d=a.viewer.camera.positionWC;a.rainParticleSystem.emitterModelMatrix=Cesium.Transforms.eastNorthUpToFixedFrame(d)})}stopRain(){this.rainParticleSystem&&(this.viewer.scene.primitives.remove(this.rainParticleSystem),this.rainParticleSystem=null)}}function C(o,t){const s=document.getElementById("waterLevel"),n=document.getElementById("levelValue");s.max=1e3,s.addEventListener("input",e=>{const i=parseFloat(e.target.value);console.log("\u6ED1\u5757\u5F53\u524D\u503C:",i),n.textContent=i,t.setWaterLevel(i)}),document.getElementById("staticBtn").addEventListener("click",()=>{const e=parseFloat(s.value);t.setWaterLevel(e)}),document.getElementById("dynamicBtn").addEventListener("click",()=>{const e=o.camera.position;t.startDynamicSimulation(e)}),document.getElementById("stopBtn").addEventListener("click",()=>{t.stopDynamicSimulation()}),document.getElementById("addBuilding").addEventListener("click",()=>{const e=o.camera.position;t.addTestBuilding(e)}),document.getElementById("addDrainage").addEventListener("click",()=>{const e=o.camera.position;t.addDrainageOutlet(e)}),document.getElementById("startRain").addEventListener("click",()=>{const e=parseInt(document.getElementById("rainDensity").value),i=parseInt(document.getElementById("rainSize").value);t.startRain(e,i)}),document.getElementById("stopRain").addEventListener("click",()=>{t.stopRain()}),o.cesiumWidget.screenSpaceEventHandler.setInputAction(e=>{const i=o.scene.pick(e.position);if(Cesium.defined(i)&&i.id){const r=i.id.name||"\u672A\u547D\u540D\u5B9E\u4F53";o.selectedEntity=i.id,o.infoBox.viewModel.description=r}},Cesium.ScreenSpaceEventType.LEFT_CLICK)}Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5Y2MwZTU2Yy1lNjk4LTQ2OGYtYTgxOC0xN2ZkMjZlZTgxNWUiLCJpZCI6MzE0MzkxLCJpYXQiOjE3NTA1NjM1NTZ9.MnrkcPHzOb0xrcBz-pSU4cz7NaKvVBPVyt6-Tt0P_1M";const m=new Cesium.Viewer("cesiumContainer",{terrainProvider:Cesium.createWorldTerrain(),animation:!1,timeline:!1});m.scene.globe.depthTestAgainstTerrain=!0;m.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(113.6254,34.7466,3e3),orientation:{pitch:Cesium.Math.toRadians(-40)}});Cesium.GeoJsonDataSource.load("/\u90D1\u5DDE.geojson",{clampToGround:!0}).then(o=>{var n,e;m.dataSources.add(o);const t=o.entities.values;for(let i=0;i<t.length;i++){const r=t[i];if(r.polygon){const l=(e=(n=r.properties)==null?void 0:n.Floor)==null?void 0:e.getValue(),c=l||3;r.polygon.extrudedHeight=c*20,r.polygon.material=Cesium.Color.GRAY.withAlpha(.9),r.polygon.outline=!0,r.polygon.outlineColor=Cesium.Color.GRAY}}new Cesium.ScreenSpaceEventHandler(m.scene.canvas).setInputAction(i=>{const r=m.scene.pick(i.position);if(Cesium.defined(r)&&r.id){const l=r.id.properties,c=l.name||"\u672A\u77E5\u5EFA\u7B51",a=l.\u697C\u5C42\u6570||"\u672A\u77E5";alert(`\u{1F3E2} \u5EFA\u7B51\u540D\u79F0\uFF1A${c}
\u{1F4CF} \u697C\u5C42\u6570\uFF1A${a}`)}},Cesium.ScreenSpaceEventType.LEFT_CLICK)});const f=new p(m);C(m,f);document.getElementById("gotoZhengzhou").addEventListener("click",()=>{m.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(113.686,34.787,2500),orientation:{pitch:Cesium.Math.toRadians(-35)}})});
